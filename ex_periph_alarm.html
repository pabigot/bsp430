<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>BSP430: Peripherals: Alarms</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20140310</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Peripherals: Alarms </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>BSP430's infrastructure supporting alarms is documented at <a class="el" href="group__grp__timer__alarm.html">Alarm-related Timer Functionality</a>. The program below provides a command-line interface allow interactive configuration of alarms. It should work on MCUs with at least 1024 bytes of RAM (needed for the various buffers supporting the command-line interface), including the <code>exp430f5438</code> and <code>exp430fr5739</code> platforms.</p>
<p>By default, the application uses ACLK as the alarm source. SMCLK may be selected by adding: </p>
<div class="fragment"><div class="line">CLK=SMCLK</div>
</div><!-- fragment --><p> to the make command line.</p>
<h1><a class="anchor" id="ex_periph_alarm_main"></a>
main.c</h1>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cli_8h.html">bsp430/utility/cli.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">bsp430/periph/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="flash_8h.html">bsp430/periph/flash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pmm_8h.html">bsp430/periph/pmm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define ALARM_TIMER_PERIPH_HANDLE BSP430_TIMER_CCACLK_PERIPH_HANDLE</span></div>
<div class="line"><span class="preprocessor">#if (APP_SOURCE_SMCLK - 0)</span></div>
<div class="line"><span class="preprocessor">#define APP_TASSEL TASSEL_2</span></div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* APP_SOURCE_SMCLK */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define APP_TASSEL TASSEL_1</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_SOURCE_SMCLK */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halTIMER.html">hBSP430halTIMER</a> alarmHAL_;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> alarm_Hz;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_TIMERS 7</span></div>
<div class="line"><a class="code" href="structsBSP430timerAlarm.html">sBSP430timerAlarm</a> alarm_data[MAX_TIMERS];</div>
<div class="line"><a class="code" href="structsBSP430timerAlarm.html">hBSP430timerAlarm</a> alarm[MAX_TIMERS];</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nTimers;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> wakeups;</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">  FLG_SkipLost = 0x01,</div>
<div class="line">  FLG_WakeFromLPM = 0x02,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sAlarmStats {</div>
<div class="line">  <span class="keywordtype">int</span> flags;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count;</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> interval_tck;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sum_late;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> last_late;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> max_late;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lost;</div>
<div class="line">} sAlarmStats;</div>
<div class="line"></div>
<div class="line"><span class="keyword">volatile</span> sAlarmStats alarm_stats[MAX_TIMERS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">alarmCallback_ni (<a class="code" href="structsBSP430timerAlarm.html">hBSP430timerAlarm</a> alarm)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">volatile</span> sAlarmStats * ap;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now_tck = <a class="code" href="timer_8h.html#a24b984912d7624627b33023f76c14d31">ulBSP430timerCounter_ni</a>(alarmHAL_, NULL);</div>
<div class="line"></div>
<div class="line">  ap = alarm_stats + alarm-&gt;<a class="code" href="structsBSP430timerAlarm.html#a7b8be8801ce97b2e017c489d316d70c8">ccidx</a>;</div>
<div class="line">  ap-&gt;count += 1;</div>
<div class="line">  ap-&gt;last_late = now_tck - alarm-&gt;<a class="code" href="structsBSP430timerAlarm.html#aa42f23d79c51dc804e7e00a940b27277">setting_tck</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (ap-&gt;last_late &gt; ap-&gt;max_late) {</div>
<div class="line">    ap-&gt;max_late = ap-&gt;last_late;</div>
<div class="line">  }</div>
<div class="line">  ap-&gt;sum_late += ap-&gt;last_late;</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; ap-&gt;interval_tck) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> setting_tck = alarm-&gt;<a class="code" href="structsBSP430timerAlarm.html#aa42f23d79c51dc804e7e00a940b27277">setting_tck</a> + ap-&gt;interval_tck;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lost = 0;</div>
<div class="line">    <span class="comment">/* Pre-check for high-speed recurring short intervals that might</span></div>
<div class="line"><span class="comment">     * violate #BSP430_TIMER_ALARM_PAST_LIMIT.  This could still fail</span></div>
<div class="line"><span class="comment">     * if we&#39;re so far behind that now_tck gets out of date, but the</span></div>
<div class="line"><span class="comment">     * cost of updating it can also be significant. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (setting_tck &lt;= now_tck) {</div>
<div class="line">      lost = (now_tck - setting_tck + ap-&gt;interval_tck - 1) / ap-&gt;interval_tck;</div>
<div class="line">      setting_tck += lost * ap-&gt;interval_tck;</div>
<div class="line">    }</div>
<div class="line">    ap-&gt;rc = <a class="code" href="group__grp__timer__alarm.html#ga691c60553180266436fbea9a9a8bfed7">iBSP430timerAlarmSet_ni</a>(alarm, setting_tck);</div>
<div class="line">    <span class="keywordflow">while</span> ((0 != ap-&gt;rc) &amp;&amp; (ap-&gt;flags &amp; FLG_SkipLost) &amp;&amp; (1000 &gt; lost)) {</div>
<div class="line">      ++lost;</div>
<div class="line">      setting_tck += ap-&gt;interval_tck;</div>
<div class="line">      ap-&gt;rc = <a class="code" href="group__grp__timer__alarm.html#ga691c60553180266436fbea9a9a8bfed7">iBSP430timerAlarmSet_ni</a>(alarm, setting_tck);</div>
<div class="line">    }</div>
<div class="line">    ap-&gt;lost += lost;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> (ap-&gt;flags &amp; FLG_WakeFromLPM) ? <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a> : 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Recommended pattern: a global variable that holds the entrypoint to</span></div>
<div class="line"><span class="comment"> * the supported commands, and a macro that is redefined after each</span></div>
<div class="line"><span class="comment"> * command is hooked in.  The macro allows commands to be disabled or</span></div>
<div class="line"><span class="comment"> * rearranged without having to change the links. */</span></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> * commandSet;</div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND NULL</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_synctest (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="comment">/* Interval should be &gt; 10ms to ensure delays don&#39;t cascade into the</span></div>
<div class="line"><span class="comment">   * next synchronization point.  I.e., the maximum late value should</span></div>
<div class="line"><span class="comment">   * be less than the interval. */</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> interval =</div>
<div class="line"><span class="preprocessor">#if (APP_SOURCE_SMCLK - 0)</span></div>
<div class="line">    100000UL</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    10000UL</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    ;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> cc;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    alarmHAL_-&gt;<a class="code" href="structsBSP430halTIMER.html#a7fb689ae502f0155fa847d2f8550d716">hpl</a>-&gt;<a class="code" href="structsBSP430hplTIMER.html#af7e38ca9803b3645a8abb261608a7957">ctl</a> &amp;= ~(MC0 | MC1);</div>
<div class="line">    <a class="code" href="timer_8h.html#adbda3deda56fd4453c32f47f51c3f861">vBSP430timerResetCounter_ni</a>(alarmHAL_);</div>
<div class="line">    <span class="keywordflow">for</span> (cc = 0; cc &lt; nTimers; ++cc) {</div>
<div class="line">      <a class="code" href="structsBSP430timerAlarm.html">hBSP430timerAlarm</a> ap = alarm[cc];</div>
<div class="line">      <span class="keywordflow">if</span> (NULL != ap) {</div>
<div class="line">        (void)<a class="code" href="group__grp__timer__alarm.html#ga916a200cdb0920d14d47e3763ed3388c">iBSP430timerAlarmCancel_ni</a>(ap);</div>
<div class="line">        (void)<a class="code" href="group__grp__timer__alarm.html#gaf78fc60de828bc03bb7c93624f384ef1">iBSP430timerAlarmSetEnabled_ni</a>(ap, 1);</div>
<div class="line">        alarm_stats[cc].interval_tck = interval;</div>
<div class="line">        alarm_stats[cc].flags |= FLG_SkipLost;</div>
<div class="line">        (void)<a class="code" href="timer_8h.html#a9649f82ab433e10123d5118671f8e91c">iBSP430timerAlarmSetForced_ni</a>(ap, 10 * interval);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    alarmHAL_-&gt;<a class="code" href="structsBSP430halTIMER.html#a7fb689ae502f0155fa847d2f8550d716">hpl</a>-&gt;<a class="code" href="structsBSP430hplTIMER.html#af7e38ca9803b3645a8abb261608a7957">ctl</a> |= <a class="code" href="msp430_8h.html#ad367be228fa82c3f35290c9141138710">MC_2</a> | TACLR;</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_synctest = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;synctest&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# synctest alarm cc&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_synctest</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_synctest)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_autotest (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> base[] = {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    <span class="comment">/* Primes testing delays nominally powers of 2 */</span></div>
<div class="line">    17, 31, 61, 127, 256, 509, 1021</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    <span class="comment">/* Primes testing delays nominally multiples of 10 */</span></div>
<div class="line">    11, 101, 499, 997, 499, 10007, 19997</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if 1</span></div>
<div class="line">    <span class="comment">/* Primes testing delays beyond 16-bits */</span></div>
<div class="line">    16381, 32749, 32771, 65537, 131101, 262147, 524309</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  };</div>
<div class="line">  <span class="keywordtype">size_t</span> nbase = <span class="keyword">sizeof</span>(base)/<span class="keyword">sizeof</span>(*base);</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordtype">int</span> cc;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="keywordtype">size_t</span> bi = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (cc = 0; cc &lt; nTimers; ++cc) {</div>
<div class="line">      <a class="code" href="structsBSP430timerAlarm.html">hBSP430timerAlarm</a> ap = alarm[cc];</div>
<div class="line">      <span class="keywordflow">if</span> (NULL != ap) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;config %p %u with %lu\n&quot;</span>, ap, cc, base[bi]);</div>
<div class="line">        (void)<a class="code" href="group__grp__timer__alarm.html#ga916a200cdb0920d14d47e3763ed3388c">iBSP430timerAlarmCancel_ni</a>(ap);</div>
<div class="line">        <span class="keywordflow">if</span> (bi &lt; nbase) {</div>
<div class="line">          (void)<a class="code" href="group__grp__timer__alarm.html#gaf78fc60de828bc03bb7c93624f384ef1">iBSP430timerAlarmSetEnabled_ni</a>(ap, 1);</div>
<div class="line">          alarm_stats[cc].interval_tck = base[bi];</div>
<div class="line">          (void)<a class="code" href="timer_8h.html#a9649f82ab433e10123d5118671f8e91c">iBSP430timerAlarmSetForced_ni</a>(ap, 4*base[bi] + <a class="code" href="timer_8h.html#a24b984912d7624627b33023f76c14d31">ulBSP430timerCounter_ni</a>(alarmHAL_, NULL));</div>
<div class="line">          ++bi;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">          (void)<a class="code" href="group__grp__timer__alarm.html#gaf78fc60de828bc03bb7c93624f384ef1">iBSP430timerAlarmSetEnabled_ni</a>(ap, 0);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_autotest = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;autotest&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# autotest alarm cc&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_autotest</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_autotest)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_cancel (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line"></div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">  <span class="keywordflow">if</span> ((0 == rv) &amp;&amp; (0 &lt;= cc) &amp;&amp; (cc &lt; nTimers)) {</div>
<div class="line">    <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      rv = <a class="code" href="group__grp__timer__alarm.html#ga916a200cdb0920d14d47e3763ed3388c">iBSP430timerAlarmCancel_ni</a>(alarm[cc]);</div>
<div class="line">    } <span class="keywordflow">while</span> (0);</div>
<div class="line">    <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Cancel %u produced %d\n&quot;</span>, cc, rv);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Bad input: %s\n&quot;</span>, command);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_cancel = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;cancel&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc} # cancel alarm cc&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_cancel</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_cancel)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_alarm (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keywordtype">long</span> rel_when;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line"></div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gab8e5b1244aae36d13305065cd9c38f35">iBSP430cliStoreExtractedL</a>(&amp;argstr, &amp;argstr_len, &amp;rel_when);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    <span class="keywordflow">if</span> ((0 &lt;= cc) &amp;&amp; (cc &lt; nTimers)) {</div>
<div class="line">      <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> abs_when;</div>
<div class="line"></div>
<div class="line">      <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        abs_when = <a class="code" href="timer_8h.html#a24b984912d7624627b33023f76c14d31">ulBSP430timerCounter_ni</a>(alarmHAL_, NULL) + rel_when;</div>
<div class="line">        rv = <a class="code" href="group__grp__timer__alarm.html#ga691c60553180266436fbea9a9a8bfed7">iBSP430timerAlarmSet_ni</a>(alarm[cc], abs_when);</div>
<div class="line">      } <span class="keywordflow">while</span> (0);</div>
<div class="line">      <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Set %u in %ld (%lu) produced %d\n&quot;</span>,</div>
<div class="line">              cc, rel_when, abs_when, rv);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Invalid cc value %u\n&quot;</span>, cc);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Bad input: %s\n&quot;</span>, command);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_alarm = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;alarm&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc} {rel_when} # set alarm for rel_when ticks&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_alarm</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_alarm)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_flags (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * key;</div>
<div class="line">  <span class="keywordtype">int</span> enablep = 0;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">int</span> flags = 0;</div>
<div class="line"></div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  key = argstr;</div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">  <span class="keywordflow">if</span> ((0 &gt; cc) || (nTimers &lt;= cc)) {</div>
<div class="line">    rv = -1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0 == rv) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flag;</div>
<div class="line">    <span class="keywordtype">size_t</span> key_len;</div>
<div class="line"></div>
<div class="line">    key = <a class="code" href="group__grp__utility__cli__hci.html#gad8ad62488676a6ef0de220019d635c29">xBSP430cliNextToken</a>(&amp;argstr, &amp;argstr_len, &amp;key_len);</div>
<div class="line">    <span class="keywordflow">if</span> (0 == key_len) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    enablep = -1;</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="charliteral">&#39;+&#39;</span> == *key) {</div>
<div class="line">      enablep = 1;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">&#39;-&#39;</span> == *key) {</div>
<div class="line">      enablep = 0;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      rv = -1;</div>
<div class="line">    }</div>
<div class="line">    ++key;</div>
<div class="line">    --key_len;</div>
<div class="line">    <span class="keywordflow">if</span> (0 == strncmp(<span class="stringliteral">&quot;wake&quot;</span>, key, key_len)) {</div>
<div class="line">      flag = FLG_WakeFromLPM;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == strncmp(<span class="stringliteral">&quot;skip&quot;</span>, key, key_len)) {</div>
<div class="line">      flag = FLG_SkipLost;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      rv = -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">      flags |= flag;</div>
<div class="line">      <span class="keywordflow">if</span> (enablep) {</div>
<div class="line">        alarm_stats[cc].flags |= flag;</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        alarm_stats[cc].flags &amp;= ~flag;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Successfully modified flags 0x%x\n&quot;</span>, flags);</div>
<div class="line">  <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;error at %s\n&quot;</span>, key);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_flags = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;flags&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc} {[+-]flg}... # enable/disable wake skip&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_flags</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_flags)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_interval (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> interval;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line"></div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gac1d3224f520dabd275954219dac876f8">iBSP430cliStoreExtractedUL</a>(&amp;argstr, &amp;argstr_len, &amp;interval);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    <span class="keywordflow">if</span> ((0 &lt;= cc) &amp;&amp; (cc &lt; nTimers)) {</div>
<div class="line">      alarm_stats[cc].interval_tck = interval;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Invalid cc value %u\n&quot;</span>, cc);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Bad input: %s\n&quot;</span>, command);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_interval = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;interval&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc} {interval} # set alarm interval, 0 one-shot&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_interval</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_interval)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_configure_ (<span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">                <span class="keywordtype">int</span> enablep)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * input;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line"></div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    input = argstr;</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">    <span class="keywordflow">if</span> ((0 == rv) &amp;&amp; (0 &lt;= cc) &amp;&amp; (cc &lt; nTimers)) {</div>
<div class="line">      <span class="keywordflow">if</span> (enablep) {</div>
<div class="line">        rv = <a class="code" href="group__grp__timer__alarm.html#ga10216d360cb1c02108e0347b628854d7">iBSP430timerAlarmEnable</a>(alarm[cc]);</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        rv = <a class="code" href="group__grp__timer__alarm.html#ga9928ff05ac8f8067c2fc8e4a0b3be331">iBSP430timerAlarmDisable</a>(alarm[cc]);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Failed cc index %d: %d\n&quot;</span>, cc, rv);</div>
<div class="line">        <span class="keywordflow">return</span> rv;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      rv = -1;</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0 == rv);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; argstr_len) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Invalid cc index at &#39;%s&#39;\n&quot;</span>, input);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_disable (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> cmd_configure_(command, 0);</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_disable = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;disable&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc}... # disable alarm cc&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_disable</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_disable)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_enable (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> cmd_configure_(command, 1);</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_enable = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;enable&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc}... # enable alarm cc&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_enable</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_enable)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_reset (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * argstr = command;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;cc);</div>
<div class="line">    <span class="keywordflow">if</span> ((0 == rv) &amp;&amp; (0 &lt;= cc) &amp;&amp; (cc &lt; nTimers)) {</div>
<div class="line">      <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">      <span class="keyword">volatile</span> sAlarmStats * sp = alarm_stats + cc;</div>
<div class="line"></div>
<div class="line">      <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        sp-&gt;count = 0;</div>
<div class="line">        sp-&gt;last_late = 0;</div>
<div class="line">        sp-&gt;max_late = 0;</div>
<div class="line">        sp-&gt;sum_late = 0;</div>
<div class="line">        sp-&gt;lost = 0;</div>
<div class="line">      } <span class="keywordflow">while</span> (0);</div>
<div class="line">      <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0 == rv);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_reset = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;reset&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{cc}... # reset alarm statistics&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_reset</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_reset)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_stats (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> ai;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Alarm statistics:\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (ai = 0; ai &lt; nTimers; ++ai) {</div>
<div class="line">    <span class="keyword">volatile</span> sAlarmStats * sp = alarm_stats + ai;</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == alarm[ai]) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %u: not available\n&quot;</span>, ai);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %u: %cset %cenab %cwake %cskip cnt %9lu, rc %d, inter %6lu\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;    lost %6lu; late: last %6ld, max %6lu, ave %6lu\n&quot;</span>,</div>
<div class="line">              ai,</div>
<div class="line">              (alarm[ai]-&gt;flags &amp; <a class="code" href="group__grp__timer__alarm.html#ga21bb8801633b35ea742bb88d804e5674">BSP430_TIMER_ALARM_FLAG_SET</a>) ? <span class="charliteral">&#39;+&#39;</span> : <span class="charliteral">&#39;-&#39;</span>,</div>
<div class="line">              (alarm[ai]-&gt;flags &amp; <a class="code" href="group__grp__timer__alarm.html#gaa5de1dec0ca2a7bc98597562a270a4ab">BSP430_TIMER_ALARM_FLAG_ENABLED</a>) ? <span class="charliteral">&#39;+&#39;</span> : <span class="charliteral">&#39;-&#39;</span>,</div>
<div class="line">              (sp-&gt;flags &amp; FLG_WakeFromLPM) ? <span class="charliteral">&#39;+&#39;</span> : <span class="charliteral">&#39;-&#39;</span>,</div>
<div class="line">              (sp-&gt;flags &amp; FLG_SkipLost) ? <span class="charliteral">&#39;+&#39;</span> : <span class="charliteral">&#39;-&#39;</span>,</div>
<div class="line">              sp-&gt;count, sp-&gt;rc, sp-&gt;interval_tck,</div>
<div class="line">              sp-&gt;lost, sp-&gt;last_late, sp-&gt;max_late,</div>
<div class="line">              (0 == sp-&gt;count) ? 0 : (sp-&gt;sum_late / sp-&gt;count));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_stats = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stats&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# Show alarm stats&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_stats</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_stats)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_dump (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now_tck;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> overflows;</div>
<div class="line">  <span class="keywordtype">int</span> ai;</div>
<div class="line"></div>
<div class="line">  now_tck = <a class="code" href="timer_8h.html#aceb3578bf4d49881b128f6bc6a9f68df">ulBSP430timerCounter</a>(alarmHAL_, &amp;overflows);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Timer ticks %lu (0x%08lx) with %u overflows and %lu wakeups\n&quot;</span>,</div>
<div class="line">          now_tck, now_tck, overflows, wakeups);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Alarm internals:\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (ai = 0; ai &lt; nTimers; ++ai) {</div>
<div class="line">    <a class="code" href="structsBSP430timerAlarm.html">hBSP430timerAlarm</a> ap = alarm[ai];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NULL == ap) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tcc %u is not available\n&quot;</span>, ai);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keywordtype">int</span> ci = ap-&gt;<a class="code" href="structsBSP430timerAlarm.html#a7b8be8801ce97b2e017c489d316d70c8">ccidx</a>;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tcc %u, flg 0x%02x, setting %lu ; CCTL %04x CCR %04x\n&quot;</span>,</div>
<div class="line">              ci, ap-&gt;<a class="code" href="structsBSP430timerAlarm.html#ab2ac4d51eccde7bff81031a9bf4cf8b1">flags</a>, ap-&gt;<a class="code" href="structsBSP430timerAlarm.html#aa42f23d79c51dc804e7e00a940b27277">setting_tck</a>,</div>
<div class="line">              alarmHAL_-&gt;<a class="code" href="structsBSP430halTIMER.html#a7fb689ae502f0155fa847d2f8550d716">hpl</a>-&gt;<a class="code" href="structsBSP430hplTIMER.html#a58b606ac397c9b2a4c65847d1ddfd67f">cctl</a>[ci], alarmHAL_-&gt;<a class="code" href="structsBSP430halTIMER.html#a7fb689ae502f0155fa847d2f8550d716">hpl</a>-&gt;<a class="code" href="structsBSP430hplTIMER.html#a485ff74654c58d73be4762b01f90f795">ccr</a>[ci]);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_dump = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;dump&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# Show alarm internals&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_dump</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_dump)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_convert (<a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">             <span class="keywordtype">void</span> * param,</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">             <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> when_tck;</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gac1d3224f520dabd275954219dac876f8">iBSP430cliStoreExtractedUL</a>(&amp;command, &amp;command_len, &amp;when_tck);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ms = (when_tck * 1000) / alarm_Hz;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> us = (when_tck * 1000) / (alarm_Hz / 1000);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%lu tt at %lu Hz = %lu ms = %lu us\n&quot;</span>, when_tck, alarm_Hz, ms, us);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_convert = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;convert&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;{tt} # show tt value in human time&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_convert</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_convert)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_clocks (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now_tck;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> timer_overhead;</div>
<div class="line"><span class="preprocessor">#if (BSP430_PMM_SUPPORTS_SVSM - 0)</span></div>
<div class="line">  <span class="keywordtype">int</span> fast_wakeup = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;CPU clocks (Hz): MCLK %lu ; SMCLK %lu ; ACLK %lu\n&quot;</span>,</div>
<div class="line">          <a class="code" href="clock_8h.html#a0555ddf2f79611fff8ce2163fbca5d38">ulBSP430clockMCLK_Hz</a>(), <a class="code" href="clock_8h.html#aae393938e85c471bb779ca0d5baa705f">ulBSP430clockSMCLK_Hz</a>(),</div>
<div class="line">          <a class="code" href="clock_8h.html#a9997899ae094a0e809c01239328f2e0b">ulBSP430clockACLK_Hz</a>());</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t0;</div>
<div class="line"></div>
<div class="line">    t0 = <a class="code" href="timer_8h.html#a24b984912d7624627b33023f76c14d31">ulBSP430timerCounter_ni</a>(alarmHAL_, NULL);</div>
<div class="line">    now_tck = <a class="code" href="timer_8h.html#a24b984912d7624627b33023f76c14d31">ulBSP430timerCounter_ni</a>(alarmHAL_, NULL);</div>
<div class="line">    timer_overhead = now_tck - t0;</div>
<div class="line"><span class="preprocessor">#if (BSP430_PMM_SUPPORTS_SVSM - 0)</span></div>
<div class="line">    fast_wakeup = (0 == (<a class="code" href="msp430_8h.html#ac11a993ad6c277854031e52bd2b1c4c1">SVSMHCTL</a> &amp; (<a class="code" href="msp430_8h.html#a79ec91d113a53e08d99d7df061bb99cc">SVMHE</a> | <a class="code" href="msp430_8h.html#aa303492df56594c301a5d90a85dfcfce">SVSHE</a>)))</div>
<div class="line">                  &amp;&amp; (0 == (<a class="code" href="msp430_8h.html#a851565872e6d9b1b747449156a44d81d">SVSMLCTL</a> &amp; (<a class="code" href="msp430_8h.html#a80f9b1f14a3e0b92470f442c97da6688">SVMLE</a> | <a class="code" href="msp430_8h.html#a775b67a8c2df6ecf7225c8de70631ead">SVSLE</a>)));</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_SET_SVSMCTL_NI */</span><span class="preprocessor"></span></div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Timer %s freq %lu Hz now %lu\n&quot;</span>, <a class="code" href="timer_8h.html#aad872aaa82973fd3accca3bcc004ea69">xBSP430timerName</a>(ALARM_TIMER_PERIPH_HANDLE), alarm_Hz, now_tck);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tResolution %lu ns/tt, overhead %lu tt @ 32bit\n&quot;</span>,</div>
<div class="line">          1000000000UL/alarm_Hz, timer_overhead);</div>
<div class="line"><span class="preprocessor">#if (BSP430_PMM_SUPPORTS_SVSM - 0)</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;PMM is %sconfigured for fast wakeup\n&quot;</span>, fast_wakeup ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;NOT &quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_SET_SVSMCTL_NI */</span><span class="preprocessor"></span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_clocks = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;clocks&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# Clock/timer information&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_clocks</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_clocks</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_uptime (<span class="keyword">const</span> <span class="keywordtype">char</span> * command)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Up %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a class="code" href="uptime_8h.html#a7e0b8aeba63d7b2ce965a650125eb8ef">ulBSP430uptime</a>()));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_uptime = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;uptime&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;# Show system uptime&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_uptime</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_uptime)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_help (<a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">          <span class="keywordtype">void</span> * param,</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">          <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__grp__utility__cli__cli.html#ga2c3a36a00ea6f676cf2006859364d45a">vBSP430cliConsoleDisplayHelp</a>(chain-&gt;<a class="code" href="structsBSP430cliCommandLink.html#ad4701a7a6b809d746683cb5b0a6f2018">cmd</a>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_help = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;help&quot;</span>,</div>
<div class="line">  .help = <span class="stringliteral">&quot;[cmd] # Show help on cmd or all commands&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_help</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND (&amp;dcmd_help)</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main ()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * command;</div>
<div class="line">  <span class="keywordtype">int</span> flags;</div>
<div class="line">  <span class="keywordtype">int</span> ai;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line">  <a class="code" href="cli_8h.html#a0a5b3cee7e2d9002d5d301b36c814d55">vBSP430cliSetDiagnosticFunction</a>(<a class="code" href="group__grp__utility__cli__cli.html#ga30922f40d6b2702628bb88d9e0069caf">iBSP430cliConsoleDiagnostic</a>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;alarm: &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if 0 &amp;&amp; (BSP430_PMM_SUPPORTS_SVSM - 0)</span></div>
<div class="line">  <span class="comment">/* Ensure fast wakeup on 5xx/6xx devices.  Absent UCS errata this</span></div>
<div class="line"><span class="comment">   * won&#39;t make much difference when SMCLK is driving the alarms,</span></div>
<div class="line"><span class="comment">   * because its use inhibits entering the really low power modes.</span></div>
<div class="line"><span class="comment">   * However, if ACLK is used then without this optimization wakeup</span></div>
<div class="line"><span class="comment">   * takes ~150us. */</span></div>
<div class="line">  <a class="code" href="pmm_8h.html#a0bf0ec44ad7918e57576e4612cc307ae">BSP430_PMM_SET_SVSMCTL_NI</a>(<a class="code" href="msp430_8h.html#ac11a993ad6c277854031e52bd2b1c4c1">SVSMHCTL</a> &amp; ~(<a class="code" href="msp430_8h.html#a79ec91d113a53e08d99d7df061bb99cc">SVMHE</a> | <a class="code" href="msp430_8h.html#aa303492df56594c301a5d90a85dfcfce">SVSHE</a>), <a class="code" href="msp430_8h.html#a851565872e6d9b1b747449156a44d81d">SVSMLCTL</a> &amp; ~(<a class="code" href="msp430_8h.html#a80f9b1f14a3e0b92470f442c97da6688">SVMLE</a> | <a class="code" href="msp430_8h.html#a775b67a8c2df6ecf7225c8de70631ead">SVSLE</a>));</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_SET_SVSMCTL_NI */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">  alarmHAL_ = <a class="code" href="timer_8h.html#afe3886cec73bfe10e638855dac7964dc">hBSP430timerLookup</a>(ALARM_TIMER_PERIPH_HANDLE);</div>
<div class="line">  <span class="keywordflow">if</span> (! alarmHAL_) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR -- Timer not available\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="timer_8h.html#adbda3deda56fd4453c32f47f51c3f861">vBSP430timerResetCounter_ni</a>(alarmHAL_);</div>
<div class="line">  alarmHAL_-&gt;<a class="code" href="structsBSP430halTIMER.html#a7fb689ae502f0155fa847d2f8550d716">hpl</a>-&gt;<a class="code" href="structsBSP430hplTIMER.html#af7e38ca9803b3645a8abb261608a7957">ctl</a> = APP_TASSEL | <a class="code" href="msp430_8h.html#ad367be228fa82c3f35290c9141138710">MC_2</a> | TACLR | TAIE;</div>
<div class="line">  <a class="code" href="timer_8h.html#a1a418c4722995ff9a7a9e766e7eeb6a6">vBSP430timerInferHints_ni</a>(alarmHAL_);</div>
<div class="line">  alarm_Hz = <a class="code" href="timer_8h.html#a6bbdf693689d7631cbada96054c065f8">ulBSP430timerFrequency_Hz_ni</a>(ALARM_TIMER_PERIPH_HANDLE);</div>
<div class="line"></div>
<div class="line">  nTimers = <a class="code" href="timer_8h.html#ae2e001792494a2b2f060db5e5a5b5f32">iBSP430timerSupportedCCs</a>(ALARM_TIMER_PERIPH_HANDLE);</div>
<div class="line">  <span class="keywordflow">if</span> (nTimers &gt; MAX_TIMERS) {</div>
<div class="line">    nTimers = MAX_TIMERS;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (ai = 0; ai &lt; nTimers; ++ai) {</div>
<div class="line">    alarm[ai] = <a class="code" href="group__grp__timer__alarm.html#ga006a132cabb227524de5203697814c12">hBSP430timerAlarmInitialize</a>(alarm_data + ai, ALARM_TIMER_PERIPH_HANDLE, ai, alarmCallback_ni);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Alarm testing with timer %s having %u CCs\n&quot;</span>,</div>
<div class="line">          <a class="code" href="timer_8h.html#aad872aaa82973fd3accca3bcc004ea69">xBSP430timerName</a>(ALARM_TIMER_PERIPH_HANDLE), nTimers);</div>
<div class="line">  cmd_clocks(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* NOTE: The control flow in this is a bit tricky, as we&#39;re trying</span></div>
<div class="line"><span class="comment">   * to leave interrupts enabled during the main body of the loop,</span></div>
<div class="line"><span class="comment">   * while they must be disabled when processing input to recognize a</span></div>
<div class="line"><span class="comment">   * command. */</span></div>
<div class="line">  commandSet = LAST_COMMAND;</div>
<div class="line">  command = NULL;</div>
<div class="line">  flags = <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line"></div>
<div class="line">  wakeups = 0;</div>
<div class="line">  <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deafdfdebe7b8568728238e4069ae19cd09">eBSP430cliConsole_DO_COMPLETION</a>) {</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_DO_COMPLETION;</div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__completion.html#ga5086d946e412fa4e9928819d664fc2cc">iBSP430cliConsoleBufferCompletion</a>(commandSet, &amp;command);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea09d4c7792c3db363181260eebd086d94">eBSP430cliConsole_READY</a>) {</div>
<div class="line">      <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">      rv = <a class="code" href="cli_8h.html#adcdb159a40c5cb6737cf97b497b58a55">iBSP430cliExecuteCommand</a>(commandSet, 0, command);</div>
<div class="line">      <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Command execution returned %d\n&quot;</span>, rv);</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Ensure prompt is rewritten, but not the command we just</span></div>
<div class="line"><span class="comment">       * ran */</span></div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line">      command = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>) {</div>
<div class="line">      <span class="comment">/* Draw the prompt along with whatever&#39;s left in the command</span></div>
<div class="line"><span class="comment">       * buffer.  Note use of leading carriage return in case an edit</span></div>
<div class="line"><span class="comment">       * left material on the current line. */</span></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\r&gt; %s&quot;</span>, command ? command : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea1af184228ab718533ff1ef6a1b4f5a8b">eBSP430cliConsole_REPAINT_BEL</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\a&#39;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT_BEL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_READY) {</div>
<div class="line">      <span class="comment">/* Clear the command we just completed */</span></div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_READY;</div>
<div class="line">      <a class="code" href="group__grp__utility__cli__cli.html#ga15ac053830a35c1b1410fda48c0e7e3a">vBSP430cliConsoleBufferClear</a>();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      <span class="comment">/* Discard any pending escape sequence */</span></div>
<div class="line">      flags = <a class="code" href="cli_8h.html#ab53c18df933fd6696f8d3e92795295f8">iBSP430cliConsoleBufferConsumeEscape</a>(flags);</div>
<div class="line">      <span class="comment">/* If no operations are pending, see if there is pending input. */</span></div>
<div class="line">      <span class="keywordflow">if</span> (0 == flags) {</div>
<div class="line">        flags = <a class="code" href="group__grp__utility__cli__cli.html#gaf192635722fef70abb4583a1c52a4e7a">iBSP430cliConsoleBufferProcessInput</a>();</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* If still no operations pending wait for something to</span></div>
<div class="line"><span class="comment">       * happen. */</span></div>
<div class="line">      <span class="keywordflow">if</span> (0 == flags) {</div>
<div class="line">        <a class="code" href="core_8h.html#a1b153003ca93d41bd574dcd4790feb6d">BSP430_CORE_LPM_ENTER</a>(<a class="code" href="msp430_8h.html#a8af1e5b3633693d9439d284100183004">LPM2_bits</a>);</div>
<div class="line">        ++wakeups;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">while</span> (! flags);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Got something to do; get the command contents in place and</span></div>
<div class="line"><span class="comment">     * restart at top of loop */</span></div>
<div class="line">    command = <a class="code" href="group__grp__utility__cli__cli.html#ga634626363e043b2a1efa7fb7b657ebe4">xBSP430cliConsoleBuffer</a>();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_periph_alarm_config"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Use a crystal if one is installed.  Much more accurate timing</span></div>
<div class="line"><span class="comment"> * results. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Support console output, and buffer it so we don&#39;t unnecessarily</span></div>
<div class="line"><span class="comment"> * delay the alarm interrupts */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_TX_BUFFER_SIZE 80</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic ACLK-driven timer so we can see</span></div>
<div class="line"><span class="comment"> * how long we&#39;ve been running. */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable an 8-character rx buffer for the console */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_RX_BUFFER_SIZE 8</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable an 80-character command buffer */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CLI_CONSOLE_BUFFER_SIZE 80</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable command completion */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CLI_COMMAND_COMPLETION 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* We&#39;ll use CCACLK as the basis for alarms.  Also grab the HAL</span></div>
<div class="line"><span class="comment"> * support so we can count overflows, and the CC0 ISR so we can put</span></div>
<div class="line"><span class="comment"> * alarms on it too. */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_TIMER_CCACLK 1</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_TIMER_CCACLK_HAL 1</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_TIMER_CCACLK_HAL_CC0_ISR 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_periph_alarm_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">CLK ?= ACLK</div>
<div class="line">PLATFORM ?= exp430f5438</div>
<div class="line"><span class="preprocessor"># Need more than 16K flash</span></div>
<div class="line">TEST_PLATFORMS_EXCLUDE=exp430fr5739 exp430g2</div>
<div class="line">AUX_CPPFLAGS = -DAPP_SOURCE_${CLK}</div>
<div class="line">MODULES=$(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += utility/cli</div>
<div class="line">SRC=main.c</div>
<div class="line">include $(BSP430_ROOT)/examples/Makefile.common</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 10 2014 14:22:18 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
