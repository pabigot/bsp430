<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>BSP430: Callback Infrastructure</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20140301</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Callback Infrastructure </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#callback_functions">Application Callback Functions</a></li>
<li class="level1"><a href="#callback_chains">Callback Chain Nodes</a></li>
<li class="level1"><a href="#callback_retval">Interrupt Callback Return Values</a></li>
<li class="level1"><a href="#callback_appinfo">Providing Extended Information to the Callback</a></li>
</ul>
</div>
<div class="textblock"><p>A key requirement for BSP430 is the ability to have independent software modules that require access to timer, port, or other peripheral interrupts without requiring that the source code for the interrupt service routine be modified to add or remove support for these modules. This is accomplished using a callback infrastructure.</p>
<p>The declarations associated with the callback infrastructure are included in the &lt;<a class="el" href="periph_8h.html" title="Generic peripheral support for MSP430 MCUs. ">bsp430/periph.h</a>&gt; header.</p>
<h1><a class="anchor" id="callback_functions"></a>
Application Callback Functions</h1>
<p>Two types of callback function are declared:</p>
<ul>
<li><a class="el" href="periph_8h.html#a0ecbae2865217d4183011e43676f8cca">iBSP430halISRCallbackVoid_ni</a> is used for normal callbacks, and provides a facility to identify the HAL structure that is handling the interrupt along with a structure specific to the callback. A stub handler definition consistent with this type is:</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">handle_rx_ni (<span class="keyword">const</span> <a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> * cb,</div>
<div class="line">              <span class="keywordtype">void</span> * context)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> * hal = (<a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> *)context;</div>
<div class="line">  (void)cb;</div>
<div class="line">  <span class="comment">/* do something with hal-&gt;rx_byte */</span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li><a class="el" href="periph_8h.html#a517036982fecb939094b6b5002267087">iBSP430halISRCallbackIndexed_ni</a> is used for callbacks that must identify a sub-resource within the peripheral, such as a port pin or a timer capture/compare block. It adds a third argument which is the sub-resource index. A stub handler definition consistent with this type is:</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">volatile</span> <span class="keywordtype">int</span> last_button;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">button_isr_ni (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a> * cb,</div>
<div class="line">               <span class="keywordtype">void</span> * context,</div>
<div class="line">               <span class="keywordtype">int</span> idx)</div>
<div class="line">{</div>
<div class="line">  (void)cb;</div>
<div class="line">  (void)context;</div>
<div class="line">  last_button = idx;</div>
<div class="line">  <span class="keywordflow">return</span> 0</div>
<div class="line">}</div>
</div><!-- fragment --><p>When registered, the callback function is invoked from within the interrupt handler upon receipt of the corresponding event.</p>
<h1><a class="anchor" id="callback_chains"></a>
Callback Chain Nodes</h1>
<p>A HAL structure supporting interrupts will include pointers to structures that define a chain of callbacks to be invoked in particular events. There is one structure for each callback style, those being <a class="el" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> and <a class="el" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a>. These structures contain only two fields: <a class="el" href="structsBSP430halISRVoidChainNode.html#a7f1281567d838c9c2396037ccbe6d447">sBSP430halISRVoidChainNode.next_ni</a> is a pointer to the next callback in the chain, while <a class="el" href="structsBSP430halISRVoidChainNode.html#a529c648d4941f29e5181ee9247bc935b">sBSP430halISRVoidChainNode.callback_ni</a> is the pointer to the function that will service the callback.</p>
<p>The HAL structure tags holding the start of the callback chain, as well as the <a class="el" href="structsBSP430halISRVoidChainNode.html#a7f1281567d838c9c2396037ccbe6d447">sBSP430halISRVoidChainNode.next_ni</a> tags within chain nodes, must only be mutated while interrupts are disabled. The steps required to add or remove a valid from the chain are straightforward and can be explicitly coded if only one callback will ever be used. Nonetheless, in the general case you should assume other resources may be linked into the callback and that the node you are removing may no longer be the head of the chain. Utility macros as exemplified below support these operations:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> cb_node = { .<a class="code" href="structsBSP430halISRVoidChainNode.html#a529c648d4941f29e5181ee9247bc935b">callback_ni</a> = handle_rx_ni };</div>
<div class="line">  <span class="comment">/* ... */</span></div>
<div class="line">  <a class="code" href="periph_8h.html#a146bd2251e2e6028ba774b98f35eea71">BSP430_HAL_ISR_CALLBACK_LINK_NI</a>(<a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a>, hal-&gt;rx_cb_chain_ni, cb_node, next_ni);</div>
<div class="line">  <span class="comment">/* ... */</span></div>
<div class="line">  <a class="code" href="periph_8h.html#a7a61d11ba7620c04e05cd290fff08ca0">BSP430_HAL_ISR_CALLBACK_UNLINK_NI</a>(<a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a>, hal-&gt;rx_cb_chain_ni, cb_node, next_ni);</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>In many cases, you will never have cause to unlink a callback from a chain. However, if you do, understand that the interrupt handler walks this chain, and any attempt to modify the chain from within a callback that is part of the chain may result in wild pointers.</dd></dl>
<h1><a class="anchor" id="callback_retval"></a>
Interrupt Callback Return Values</h1>
<p>The callback chain infrastructure supports an arbitrary number of notifications resulting from a single event. In many cases, it would be improper to invoke chain elements past the point where the event was completely handled. In addition, it is necessary to inform the interrupt handler top half when a low power mode should be exited. This information is conveyed to the interrupt through the return value of the callback handler, using a set of flags formed by combining bit values defined in &lt;<a class="el" href="periph_8h.html" title="Generic peripheral support for MSP430 MCUs. ">bsp430/periph.h</a>&gt;. The current set of callback flags is:</p>
<table class="doxtable">
<tr>
<th align="left">Name </th><th align="left">Purpose  </th></tr>
<tr>
<td align="left"><a class="el" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a> </td><td align="left">Interrupt handler wakes from LPM by clearing the <a class="el" href="core_8h.html#a2b4afc21563d1222ddc2cda30168c052">BSP430_CORE_LPM_EXIT_MASK</a> bits in the status register stored on interrupt entry </td></tr>
<tr>
<td align="left"><a class="el" href="periph_8h.html#a0ff53da75572326697c26bef9dae0351">BSP430_HAL_ISR_CALLBACK_BREAK_CHAIN</a> </td><td align="left">Interrupt handler does not invoke any subsequent callbacks in the chain </td></tr>
<tr>
<td align="left"><a class="el" href="periph_8h.html#a91d408b6d97a12b296903e07b095d9c4">BSP430_HAL_ISR_CALLBACK_YIELD</a> </td><td align="left">Interrupt handler should inform an RTOS that a context switch is required </td></tr>
<tr>
<td align="left"><a class="el" href="periph_8h.html#a94d022aee289b5f9350fbce9e6973078">BSP430_HAL_ISR_CALLBACK_DISABLE_INTERRUPT</a> </td><td align="left">Interrupt handler should disable the peripheral-specific interrupt </td></tr>
</table>
<p>The return value from a handler which receives an input character is likely to be:</p>
<div class="fragment"><div class="line"><span class="keywordflow">return</span> <a class="code" href="periph_8h.html#a0ff53da75572326697c26bef9dae0351">BSP430_HAL_ISR_CALLBACK_BREAK_CHAIN</a></div>
<div class="line">     | <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a>;</div>
</div><!-- fragment --><p><a class="el" href="periph_8h.html#a0ff53da75572326697c26bef9dae0351">BSP430_HAL_ISR_CALLBACK_BREAK_CHAIN</a> indicates that the handler has consumed the input; it would be inappropriate to continue to pass it on to subsequent handlers. <a class="el" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a> is added to cause the interrupt to exit any low power mode it might be in, so that normal processing can deal with the event.</p>
<p>The return value from a handler which transmits an output character and for which there are no additional output characters queued would add <a class="el" href="periph_8h.html#a94d022aee289b5f9350fbce9e6973078">BSP430_HAL_ISR_CALLBACK_DISABLE_INTERRUPT</a>, to inhibit the transmission interrupt from recurring. See <a class="el" href="serial_8h.html#ab94651c6368443f4040227961d765b1f">vBSP430serialWakeupTransmit_rh</a>.</p>
<h1><a class="anchor" id="callback_appinfo"></a>
Providing Extended Information to the Callback</h1>
<p>In some cases it is helpful for the callback function to be provided additional information, for example state that is exchanged between the interrupt routine and control flow outside the interrupt. Rather than provide another parameter to the callback handler, such state can be stored in a location at a fixed offset from the callback chain node that is already passed.</p>
<p>The following code from the <a class="el" href="console_8h.html">console utility </a> demonstrates how to provide a buffer for incoming characters that is specific to the callback structure. The same technique can be used for other state.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sConsoleRxBuffer {</div>
<div class="line">  <a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> cb_node;</div>
<div class="line">  <span class="keywordtype">char</span> buffer[<a class="code" href="console_8h.html#a8f5e617854ea03057eb555413356a0d7">BSP430_CONSOLE_RX_BUFFER_SIZE</a>];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> head;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tail;</div>
<div class="line">} sConsoleRxBuffer;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">console_rx_isr_ni (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> * cb,</div>
<div class="line">                   <span class="keywordtype">void</span> * context)</div>
<div class="line">{</div>
<div class="line">  sConsoleRxBuffer * bufp = (sConsoleRxBuffer *)cb;</div>
<div class="line">  <a class="code" href="structsBSP430halSERIAL.html">sBSP430halSERIAL</a> * hal = (<a class="code" href="structsBSP430halSERIAL.html">sBSP430halSERIAL</a> *)context;</div>
<div class="line"></div>
<div class="line">  bufp-&gt;buffer[bufp-&gt;head] = hal-&gt;<a class="code" href="structsBSP430halSERIAL.html#a15e5570eb45ae458119bb23a3a346dfc">rx_byte</a>;</div>
<div class="line">  bufp-&gt;head = (bufp-&gt;head + 1) &amp; ((<span class="keyword">sizeof</span>(bufp-&gt;buffer) / <span class="keyword">sizeof</span>(*bufp-&gt;buffer)) - 1);</div>
<div class="line">  <span class="keywordflow">if</span> (bufp-&gt;head == bufp-&gt;tail) {</div>
<div class="line">    bufp-&gt;tail = (bufp-&gt;tail + 1) &amp; ((<span class="keyword">sizeof</span>(bufp-&gt;buffer) / <span class="keyword">sizeof</span>(*bufp-&gt;buffer)) - 1);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> sConsoleRxBuffer rx_buffer_ = {</div>
<div class="line">  .cb_node = { .callback_ni = console_rx_isr_ni },</div>
<div class="line">};</div>
</div><!-- fragment --><p>Copyright 2012-2014, Peter A. Bigot </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Mar 1 2014 16:30:48 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
