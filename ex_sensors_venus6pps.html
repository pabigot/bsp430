<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>BSP430: Sensors: SkyTraq Venus 638FLPx as Time Source</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20140301</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Sensors: SkyTraq Venus 638FLPx as Time Source </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a class="el" href="skytraq_8h.html">SkyTraq Venus 638FLPx</a> is a <a class="el" href="gps_8h.html">GPS sensor</a> which provides a one-pulse-per-second output synchronized to GPS time. This example uses that to capture the ACLK counter and determine the relationship between <a class="el" href="uptime_8h.html#a7e0b8aeba63d7b2ce965a650125eb8ef">ulBSP430uptime()</a> and UTC time.</p>
<p>Example output:</p>
<pre class="fragment">15:28.278: Wokeup with 3, lost 0 octets in 0/d 0/a
        fix 2 GPS week 1721 sec 402481: 1357228065.040: Thu Jan  3 15:47:45 2013
        UTT-to-UTC offset -81 after 837 s; UTT  gained  0:00.002  in 13:57.000
15:29.280: Wokeup with 3, lost 0 octets in 0/d 0/a
        fix 2 GPS week 1721 sec 402482: 1357228066.040: Thu Jan  3 15:47:46 2013
        UTT-to-UTC offset -81 after 838 s; UTT  gained  0:00.002  in 13:58.000
</pre><dl class="section note"><dt>Note</dt><dd>The implementation for this sensor makes use of <a href="http://pabigot.github.com/fragpool">Fragpool</a>, a library designed to manage packetized data in embedded communications stacks.</dd></dl>
<h1><a class="anchor" id="ex_sensors_venus6pps_timesync"></a>
Venus 638FLPx Time Synchronization</h1>
<p>GPS data is emitted either in a block of NMEA sentences or a single binary <a class="el" href="structsSkyTraqMsgOut__NAV__DATA.html">sSkyTraqMsgOut_NAV_DATA</a> packet, once per second, at a fixed interval relative to power-up or reset. Multiple NMEA sentences in a block reference the same time.</p>
<p>On power up, the timestamp starts at 2006-06-28T11:59:45Z and increments in whole seconds. Once GPS transmissions start getting decoded there is a jump to the approximate time at a 1 second resolution. A second adjustment to full precision is made when synchronization is complete. This latter adjustment may be more or less than one second, depending on the error. Sometime after that 1PPS starts showing up.</p>
<p>For NMEA sentences the time is UTC and has a precision of 1ms.</p>
<p>The binary <a class="el" href="structsSkyTraqMsgOut__NAV__DATA.html">sSkyTraqMsgOut_NAV_DATA</a> message represents time in two components: the GPS week, and the GPS second-of-week as a multiple of 0.01s. The GPS week is not provided modulo 1024, so no week rollover need be considered. However, the packet does not include the GPS-to-UTC offset. As of 2012-07-01T00:00:00 GPS is 16 seconds ahead of UTC, meaning that 1600 must be subtracted from the GPS centisecond to provide the UTC centisecond.</p>
<p>Analysis suggests that timestamps lag the 1PPS signal by between 100ms and 200ms. Thus a timestamp with a fractional part of 0.650 seconds might start transmission 800ms after the 1pps that it describes.</p>
<p>If the Venus is restarted with no-mode-change in <a class="el" href="structsSkyTraqMsgIn__RESTART.html#a6e80ec621d2c75b8a47f7fa8262bb766">sSkyTraqMsgIn_RESTART.mode</a> synchronization resumes within a few seconds and timestamps are synchronized to near the whole second, although the 100ms+ lag remains. This is still worth doing as it reduces the likelihood that a timestamp is associated with the wrong 1PPS event.</p>
<h1><a class="anchor" id="ex_sensors_venus6pps_main"></a>
main.c</h1>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="led_8h.html">bsp430/utility/led.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serial_8h.html">bsp430/serial.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="gps_8h.html">bsp430/utility/gps.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="skytraq_8h.html">bsp430/sensors/skytraq.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define GPS_STATE_1PPS 0x01</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define GPS_STATE_RX 0x02</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define GPS_STATE_TX_DONE 0x04</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define GPS_STATE_SAW_NMEA 0x08</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sAppGPSState {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags;</div>
<div class="line"></div>
<div class="line">  uint8_t keep_fix;</div>
<div class="line"></div>
<div class="line">  uint8_t last_fix;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> last_week_be;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dropped_fix;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> app_lost_pkts;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> driver_lost_pkts;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lost_octets;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> uint8_t * msg;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> msg_len;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rx_utt;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pps_tt;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> tx_rc;</div>
<div class="line">} sAppGPSState;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> sAppGPSState gps_state_;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">gps_serial_cb (<span class="keyword">const</span> uint8_t * msg,</div>
<div class="line">               <span class="keywordtype">size_t</span> len,</div>
<div class="line">               <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rx_utt)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <a class="code" href="unionuSkyTraqMsg.html">uSkyTraqMsg</a> * up = (<a class="code" href="unionuSkyTraqMsg.html">uSkyTraqMsg</a> *)msg;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags = GPS_STATE_RX;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* The going-in assumption is the driver should wake the</span></div>
<div class="line"><span class="comment">   * application, but branches below might override this. */</span></div>
<div class="line">  rc = <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (NULL == msg) {</div>
<div class="line">    <span class="comment">/* Record a packet lost within the driver itself. */</span></div>
<div class="line">    ++gps_state_.driver_lost_pkts;</div>
<div class="line">    gps_state_.lost_octets += len;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NULL == gps_state_.msg) {</div>
<div class="line">    <span class="keywordflow">switch</span> (up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a70c8feb84fbda0dbfdff198d19ff7040">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>) {</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a009dddaafd735ecc166824348d0c5030">eSkyTraqMID_NMEA</a>:</div>
<div class="line">        <span class="comment">/* We don&#39;t decode NMEA messages; drop it and flag it so the</span></div>
<div class="line"><span class="comment">         * application can switch the GPS to binary mode. */</span></div>
<div class="line">        flags = GPS_STATE_SAW_NMEA;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341ad168c021467275713719dd48f9532f34">eSkyTraqMIDout_NAV_DATA</a>:</div>
<div class="line">        <span class="comment">/* Drop data with inadequate GPS fix unless either the fix</span></div>
<div class="line"><span class="comment">         * level or the gross time has changed since the last</span></div>
<div class="line"><span class="comment">         * notification. */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data.<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a> &lt; gps_state_.keep_fix)</div>
<div class="line">            &amp;&amp; (up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data.<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a> == gps_state_.last_fix)</div>
<div class="line">            &amp;&amp; (up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data.<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a4b2bd79cef10d707ba84dfe998fd8b91">gps_week_be</a> == gps_state_.last_week_be)) {</div>
<div class="line">          flags = 0;</div>
<div class="line">          rc = 0;</div>
<div class="line">          gps_state_.dropped_fix += 1;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Record the filter-related information from this packet and</span></div>
<div class="line"><span class="comment">         * pass it on to the application. */</span></div>
<div class="line">        gps_state_.last_fix = up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data.<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a>;</div>
<div class="line">        gps_state_.last_week_be = up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data.<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a4b2bd79cef10d707ba84dfe998fd8b91">gps_week_be</a>;</div>
<div class="line">        <span class="keywordflow">goto</span> accept;</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a2449bdff4d857d5f44a2f53b7d0c0672">eSkyTraqMIDout_ACK</a>:</div>
<div class="line">        <span class="comment">/* Ignore the ACKs that don&#39;t have a valid MID.  Accept the</span></div>
<div class="line"><span class="comment">         * others. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (0 == up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.ack.<a class="code" href="structsSkyTraqMsgOut__ACK.html#af41c27adf52516ebe91997640f70bae6">in_mid</a>) {</div>
<div class="line">          rc = 0;</div>
<div class="line">          flags = 0;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">      <span class="comment">/*FALLTHRU*/</span></div>
<div class="line">      <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="comment">/* Accept everything else */</span></div>
<div class="line">accept:</div>
<div class="line">        gps_state_.msg = msg;</div>
<div class="line">        gps_state_.msg_len = len;</div>
<div class="line">        gps_state_.rx_utt = rx_utt;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* We only buffer a single packet and the application hasn&#39;t</span></div>
<div class="line"><span class="comment">     * completed processing the last one we received. */</span></div>
<div class="line">    ++gps_state_.app_lost_pkts;</div>
<div class="line">    gps_state_.lost_octets += len;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Free this message if it isn&#39;t now the responsibility of the</span></div>
<div class="line"><span class="comment">   * application. */</span></div>
<div class="line">  <span class="keywordflow">if</span> ((NULL != msg) &amp;&amp; (gps_state_.msg != msg)) {</div>
<div class="line">    <a class="code" href="gps_8h.html#a2fbd65b94db95384ae39b310173a106a">vBSP430gpsReleaseMessage_ni</a>(msg);</div>
<div class="line">  }</div>
<div class="line">  gps_state_.flags |= flags;</div>
<div class="line">  <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">gps_pps_cb (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pps_tck)</div>
<div class="line">{</div>
<div class="line">  gps_state_.flags |= GPS_STATE_1PPS;</div>
<div class="line">  gps_state_.pps_tt = pps_tck;</div>
<div class="line">  <span class="comment">/* Don&#39;t wake up on 1PPS; we&#39;ll wake on the subsequent message that</span></div>
<div class="line"><span class="comment">   * says what time the 1PPS occurred. */</span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">gps_tx_complete (<span class="keyword">const</span> uint8_t * msg,</div>
<div class="line">                 <span class="keywordtype">int</span> rc)</div>
<div class="line">{</div>
<div class="line">  gps_state_.flags |= GPS_STATE_TX_DONE;</div>
<div class="line">  gps_state_.tx_rc = rc;</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="unionuSkyTraqMsgIn.html">uSkyTraqMsgIn</a> tx_message;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">size_t</span> tx_length;</div>
<div class="line">  <span class="keyword">const</span> uint8_t * msg_to_release;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_sync = 0;</div>
<div class="line">  time_t sync_utc = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sync_utt = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> min_lag = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> max_lag = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> utt_per_sec;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line"></div>
<div class="line">  utt_per_sec = <a class="code" href="uptime_8h.html#abee524dac4c6d777b5493f1c16bc1c2a">ulBSP430uptimeConversionFrequency_Hz_ni</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\n\nrtc &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Uptime clock uses %lu Hz\n&quot;</span>, utt_per_sec);</div>
<div class="line"></div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="structsBSP430gpsConfiguration.html">sBSP430gpsConfiguration</a> config;</div>
<div class="line">    <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">    memset(&amp;config, 0, <span class="keyword">sizeof</span>(config));</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#aff98ff33717d724f0e594529249bfdbc">nmea_serial</a> = APP_NMEA_UART_PERIPH_HANDLE;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#a9f521e70a43c92daf36beec9e9c983f5">nmea_baud</a> = APP_NMEA_BAUD_RATE;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#ae95d838b0c7d30086936e66761859f26">pps_port</a> = APP_PPS_PORT_PERIPH_HANDLE;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#ac03d7f5d2c63ff906e50e8f33a80003d">pps_port_bit</a> = APP_PPS_PORT_BIT;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#ab3f7481db3bd6f1c31cf8625209edb76">pps_timer</a> = <a class="code" href="uptime_8h.html#a6d4b3ca225b4057be8a5c6f05de6eb7e">BSP430_UPTIME_TIMER_PERIPH_HANDLE</a>;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#a980a2d8546bb09fc75b025cb1c146a79">pps_ccidx</a> = APP_PPS_CCIDX;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#ad1551aa86e73f298bc9e13ab1cecba48">pps_ccis</a> = APP_PPS_CCIS;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#adef8cac6c278fd984dd5825d5d79ecc6">serial_cb</a> = gps_serial_cb;</div>
<div class="line">    config.<a class="code" href="structsBSP430gpsConfiguration.html#a1e46716ba3ac8cd6b3d1faab1e1d56d7">pps_cb</a> = gps_pps_cb;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Connect NMEA serial data at %lu baud to %s at:\n\t%s\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)config.<a class="code" href="structsBSP430gpsConfiguration.html#a9f521e70a43c92daf36beec9e9c983f5">nmea_baud</a>,</div>
<div class="line">            <a class="code" href="serial_8h.html#a7f2e6f39abd1faca343663917e34840a">xBSP430serialName</a>(config.<a class="code" href="structsBSP430gpsConfiguration.html#aff98ff33717d724f0e594529249bfdbc">nmea_serial</a>),</div>
<div class="line">            <a class="code" href="platform_8h.html#ad5df0a450196592bc395c5efe89a6fb3">xBSP430platformPeripheralHelp</a>(config.<a class="code" href="structsBSP430gpsConfiguration.html#aff98ff33717d724f0e594529249bfdbc">nmea_serial</a>, 0));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Connect 1PPS to %s.%u on %s.%u\n&quot;</span>,</div>
<div class="line">            <a class="code" href="timer_8h.html#aad872aaa82973fd3accca3bcc004ea69">xBSP430timerName</a>(config.<a class="code" href="structsBSP430gpsConfiguration.html#ab3f7481db3bd6f1c31cf8625209edb76">pps_timer</a>),</div>
<div class="line">            config.<a class="code" href="structsBSP430gpsConfiguration.html#a980a2d8546bb09fc75b025cb1c146a79">pps_ccidx</a>,</div>
<div class="line">            <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(config.<a class="code" href="structsBSP430gpsConfiguration.html#ae95d838b0c7d30086936e66761859f26">pps_port</a>),</div>
<div class="line">            <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(config.<a class="code" href="structsBSP430gpsConfiguration.html#ac03d7f5d2c63ff906e50e8f33a80003d">pps_port_bit</a>));</div>
<div class="line"></div>
<div class="line">    rv = <a class="code" href="gps_8h.html#a34edaac99e0aa4ef7e4ecb906a5a17f5">iBSP430gpsInitialize_ni</a>(&amp;config, NULL);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;GPS init got %d\n&quot;</span>, rv);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Queue up a version message so we have evidence the sensor is</span></div>
<div class="line"><span class="comment">   * connected and responsive. */</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structsSkyTraqMsgIn__SW__VERSION.html">sSkyTraqMsgIn_SW_VERSION</a> * mp = &amp;tx_message.sw_version;</div>
<div class="line">    memset(mp, 0, <span class="keyword">sizeof</span>(*mp));</div>
<div class="line">    mp-&gt;<a class="code" href="structsSkyTraqMsgIn__SW__VERSION.html#a73162cc178a841f145eb0b9360a07170">mid</a> = <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341ab38cf8eb289764ea9e771581272ef2d5">eSkyTraqMIDin_QRY_SW_VERSION</a>;</div>
<div class="line">    mp-&gt;<a class="code" href="structsSkyTraqMsgIn__SW__VERSION.html#afc298931b07824d9ed88da0b8d3bce28">type</a> = 1;</div>
<div class="line">    tx_length = <span class="keyword">sizeof</span>(*mp);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Queued SW version query\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Initialize the application state.  To reduce noise during startup</span></div>
<div class="line"><span class="comment">   * discard NAV_DATA messages with fixes below 2 (=3D) that don&#39;t</span></div>
<div class="line"><span class="comment">   * change from the last fix displayed. */</span></div>
<div class="line">  memset((<span class="keywordtype">void</span>*)&amp;gps_state_, 0, <span class="keyword">sizeof</span>(gps_state_));</div>
<div class="line">  gps_state_.keep_fix = 2;</div>
<div class="line">  gps_state_.last_fix = -1;</div>
<div class="line"></div>
<div class="line">  sync_utc = 0;</div>
<div class="line">  msg_to_release = NULL;</div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordtype">char</span> timestamp[<a class="code" href="uptime_8h.html#ae47d677ac9443e2e26608ef5278f1a6d">BSP430_UPTIME_AS_TEXT_LENGTH</a>];</div>
<div class="line">    sAppGPSState state;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now_utt;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      <span class="comment">/* Free any driver-provided buffer that we&#39;re done with. */</span></div>
<div class="line">      <span class="keywordflow">if</span> (NULL != msg_to_release) {</div>
<div class="line">        <a class="code" href="gps_8h.html#a2fbd65b94db95384ae39b310173a106a">vBSP430gpsReleaseMessage_ni</a>(msg_to_release);</div>
<div class="line">        msg_to_release = NULL;</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Initiate any pending transmission */</span></div>
<div class="line">      <span class="keywordflow">if</span> (0 &lt; tx_length) {</div>
<div class="line">        rc = <a class="code" href="gps_8h.html#a58f896ebe61b9270135bd9b92358a483">iBSP430gpsTransmit_ni</a>((uint8_t*)&amp;tx_message, tx_length, gps_tx_complete);</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;TX MID %u request got %d\n&quot;</span>, tx_message.<a class="code" href="unionuSkyTraqMsgIn.html#a5ebcb2be2a304ef630102db0203af6b8">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>, rc);</div>
<div class="line">        <span class="comment">/* Clear the request only if the request was accepted.</span></div>
<div class="line"><span class="comment">         * There&#39;s error recovery that could be done here. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">          tx_length = 0;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Wait 30 seconds or until something happens. */</span></div>
<div class="line">      <a class="code" href="uptime_8h.html#a5d852ee2f8f7ec9a52e542cbf8d57c27">BSP430_UPTIME_DELAY_MS_NI</a>(30000, <a class="code" href="msp430_8h.html#a44fde789b84d1b15c41e577d6a080eff">LPM0_bits</a>, gps_state_.flags);</div>
<div class="line"></div>
<div class="line">      <span class="comment">/* Capture the driver state then clear the pieces that we accept</span></div>
<div class="line"><span class="comment">       * responsibility for. */</span></div>
<div class="line">      state = gps_state_;</div>
<div class="line">      gps_state_.flags = 0;</div>
<div class="line">      gps_state_.msg = NULL;</div>
<div class="line"></div>
<div class="line">      <span class="comment">/* Grab the current time while we have interrupts disabled. */</span></div>
<div class="line">      now_utt = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">    } <span class="keywordflow">while</span> (0);</div>
<div class="line">    <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s: Wokeup with %x, lost %u octets in %u/d %u/a\n&quot;</span>,</div>
<div class="line">            <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(now_utt, timestamp),</div>
<div class="line">            state.flags, state.lost_octets, state.driver_lost_pkts, state.app_lost_pkts);</div>
<div class="line">    <span class="keywordflow">if</span> (NULL != state.msg) {</div>
<div class="line">      <a class="code" href="unionuSkyTraqMsg.html">uSkyTraqMsg</a> * up = (<a class="code" href="unionuSkyTraqMsg.html">uSkyTraqMsg</a> *)state.msg;</div>
<div class="line"></div>
<div class="line">      <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(state.rx_utt, timestamp);</div>
<div class="line">      <span class="keywordflow">switch</span> (up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a70c8feb84fbda0dbfdff198d19ff7040">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a009dddaafd735ecc166824348d0c5030">eSkyTraqMID_NMEA</a>:</div>
<div class="line">          <span class="comment">/* Emit any NMEA messages that passed the callback filter */</span></div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s [%u]: %s\n&quot;</span>, timestamp, state.msg_len, state.msg);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a2449bdff4d857d5f44a2f53b7d0c0672">eSkyTraqMIDout_ACK</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a15abc8153a2e573e927759e7afd55adc">eSkyTraqMIDout_NACK</a>:</div>
<div class="line">          <span class="comment">/* Display command acknowledgements */</span></div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s: %s %u\n&quot;</span>, timestamp, (<a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a15abc8153a2e573e927759e7afd55adc">eSkyTraqMIDout_NACK</a> == up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a70c8feb84fbda0dbfdff198d19ff7040">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>) ? <span class="stringliteral">&quot;NACK&quot;</span> : <span class="stringliteral">&quot;ACK&quot;</span>, up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.ack.<a class="code" href="structsSkyTraqMsgOut__ACK.html#af41c27adf52516ebe91997640f70bae6">in_mid</a>);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a7f075eb6eaa0f4fe30a6acaf28ba6e95">eSkyTraqMIDout_SW_VERSION</a>:</div>
<div class="line">          <span class="comment">/* Display the software version */</span></div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s: SW version kernel %08lx odm %08lx rev %08lx\n&quot;</span>,</div>
<div class="line">                  timestamp,</div>
<div class="line">                  up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.sw_version.<a class="code" href="structsSkyTraqMsgOut__SW__VERSION.html#ab09a88a4e8198201436fa53406692dd6">kernel</a>,</div>
<div class="line">                  up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.sw_version.<a class="code" href="structsSkyTraqMsgOut__SW__VERSION.html#a17ab5d4b01a752b06df33344b8a44cd0">odm</a>,</div>
<div class="line">                  up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.sw_version.<a class="code" href="structsSkyTraqMsgOut__SW__VERSION.html#a5e4622be3088b22002176312b5d0769a">revision</a>);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341ad168c021467275713719dd48f9532f34">eSkyTraqMIDout_NAV_DATA</a>: {</div>
<div class="line">          <span class="keyword">struct </span>tm when_tm;</div>
<div class="line">          <span class="keywordtype">char</span> cbuf[26];</div>
<div class="line">          <span class="keyword">struct </span><a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html">sSkyTraqMsgOut_NAV_DATA</a> * np = &amp;up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a131b3155d05159744ad6ced30460fdea">out</a>.nav_data;</div>
<div class="line">          uint16_t gps_week = <a class="code" href="core_8h.html#a84c412651d14e0096737c2458a67be72">BSP430_CORE_SWAP_16</a>(np-&gt;<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a4b2bd79cef10d707ba84dfe998fd8b91">gps_week_be</a>);</div>
<div class="line">          uint32_t gps_csow = <a class="code" href="core_8h.html#aad9ad180984ee45b1b8fe2be4084173e">BSP430_CORE_SWAP_32</a>(np-&gt;<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a7c720ee7fb8da376be1dc9e3892e3f34">gps_tow_cs_be</a>);</div>
<div class="line">          uint16_t msec = (gps_csow % 100) * 10;</div>
<div class="line">          uint32_t gps_sow = gps_csow / 100;</div>
<div class="line">          time_t when_utc;</div>
<div class="line"></div>
<div class="line">          when_utc = <a class="code" href="gps_8h.html#a3c372f07bd98a2de291929c21a749caa">xBSP430gpsConvertGPStoUTC_ni</a>(gps_week, gps_sow);</div>
<div class="line">          gmtime_r(&amp;when_utc, &amp;when_tm);</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tfix %u GPS week %d sec %lu: %lu.%03u: %s&quot;</span>,</div>
<div class="line">                  np-&gt;<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a>, gps_week, gps_sow, when_utc, msec, ctime_r(&amp;when_utc, cbuf));</div>
<div class="line"></div>
<div class="line">          <span class="comment">/* Reset if we&#39;ve lost the GPS fix */</span></div>
<div class="line">          <span class="keywordflow">if</span> (0 == np-&gt;<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a>) {</div>
<div class="line">            sync_utc = 0;</div>
<div class="line">          }</div>
<div class="line"></div>
<div class="line">          <span class="keywordflow">if</span> (state.flags &amp; GPS_STATE_1PPS) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lag = state.rx_utt - state.pps_tt;</div>
<div class="line">            <span class="keywordtype">int</span> show_lag = (0 == when_tm.tm_sec);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Maintain statistics on the delta between the 1PPS and</span></div>
<div class="line"><span class="comment">             * the start of the following message, which is expected</span></div>
<div class="line"><span class="comment">             * to reflect the time at the most recent 1PPS.  This is</span></div>
<div class="line"><span class="comment">             * partly why we use NAV_DATA: so we get one message per</span></div>
<div class="line"><span class="comment">             * second, rather than a set of NMEA messages.  Display</span></div>
<div class="line"><span class="comment">             * those statistics when they change, or once per</span></div>
<div class="line"><span class="comment">             * minute. */</span></div>
<div class="line">            <span class="keywordflow">if</span> ((0 == min_lag) || (lag &lt; min_lag)) {</div>
<div class="line">              min_lag = lag;</div>
<div class="line">              show_lag = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (lag &gt; max_lag) {</div>
<div class="line">              max_lag = lag;</div>
<div class="line">              show_lag = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (show_lag) {</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tmin lag %lu = %s;&quot;</span>, min_lag, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(min_lag, timestamp));</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; max lag %lu = %s\n&quot;</span>, max_lag, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(max_lag, timestamp));</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* The lag between when a message arrives and the</span></div>
<div class="line"><span class="comment">             * timestamp encoded in it is normally about 150ms +/-</span></div>
<div class="line"><span class="comment">             * 50ms.  If the fractional second in the timestamp is</span></div>
<div class="line"><span class="comment">             * more than 50ms away from the whole second assume the</span></div>
<div class="line"><span class="comment">             * sensor is gratuitously delaying the notification so</span></div>
<div class="line"><span class="comment">             * that the update is spaced consistently with previous</span></div>
<div class="line"><span class="comment">             * updates.  This means the delay gets mixed up with the</span></div>
<div class="line"><span class="comment">             * lag so we can&#39;t be sure that the timestamp doesn&#39;t</span></div>
<div class="line"><span class="comment">             * refer to a different 1PPS event.  (The offset does</span></div>
<div class="line"><span class="comment">             * drift, so give it 50ms leeway.)</span></div>
<div class="line"><span class="comment">             *</span></div>
<div class="line"><span class="comment">             * If it looks like the sensor is introducing gratuitous</span></div>
<div class="line"><span class="comment">             * delays, use a hot restart that preserves mode to change</span></div>
<div class="line"><span class="comment">             * the update basis so the timestamp is re-aligned with</span></div>
<div class="line"><span class="comment">             * the 1PPS.  It&#39;ll still be about 150ms late, but there</span></div>
<div class="line"><span class="comment">             * won&#39;t be such a risk that the notification is for a</span></div>
<div class="line"><span class="comment">             * previous 1PPS event.  (Don&#39;t do this if the 1PPS isn&#39;t</span></div>
<div class="line"><span class="comment">             * valid since the reset might prevent the unit from</span></div>
<div class="line"><span class="comment">             * resynchronizing quickly.  Also don&#39;t try it if the</span></div>
<div class="line"><span class="comment">             * transmit buffer isn&#39;t available.) */</span></div>
<div class="line">            <span class="keywordflow">if</span> (((50 &lt;= msec) &amp;&amp; (msec &lt;= 950))</div>
<div class="line">                &amp;&amp; (2 &lt;= np-&gt;<a class="code" href="structsSkyTraqMsgOut__NAV__DATA.html#a22c8474538e69515640b1abb6f446ecf">fix_mode</a>)) {</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tExcessive timestamp offset detected: %u ms\n&quot;</span>, msec);</div>
<div class="line">              <span class="keywordflow">if</span> (0 == tx_message.<a class="code" href="unionuSkyTraqMsgIn.html#a5ebcb2be2a304ef630102db0203af6b8">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structsSkyTraqMsgIn__RESTART.html">sSkyTraqMsgIn_RESTART</a> * mp = &amp;tx_message.restart;</div>
<div class="line"></div>
<div class="line">                memset(mp, 0, <span class="keyword">sizeof</span>(*mp));</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#a01e2800757aceb74ad037484981252b9">mid</a> = <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341a2cb54631ddd980cd87dc5dcfa25d72be">eSkyTraqMIDin_RESTART</a>;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#a6e80ec621d2c75b8a47f7fa8262bb766">mode</a> = 0;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#a829555a6b1d7e02293c37656d103cfbf">year_be</a> = <a class="code" href="core_8h.html#a84c412651d14e0096737c2458a67be72">BSP430_CORE_SWAP_16</a>(when_tm.tm_year);</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#a7a646701c60efaea5ca6e843f7ca5d51">mon</a> = when_tm.tm_mon - 1;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#af5c2a88b86b91e05cf04e6aa73789575">mday</a> = when_tm.tm_mday;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#af3590dd3d228a1565c2535a54646667b">hour</a> = when_tm.tm_hour;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#a93df6a65968ccdb11b529d2e7de19066">min</a> = when_tm.tm_min;</div>
<div class="line">                mp-&gt;<a class="code" href="structsSkyTraqMsgIn__RESTART.html#aaa1519f7b2845569dcf127a54d80e473">sec</a> = when_tm.tm_sec;</div>
<div class="line">                tx_length = <span class="keyword">sizeof</span>(*mp);</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;** Queued restart command\n&quot;</span>);</div>
<div class="line">              }</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == sync_utc) {</div>
<div class="line">              ++num_sync;</div>
<div class="line">              sync_utc = when_utc;</div>
<div class="line">              sync_utt = state.pps_tt;</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;** First sync: %lu POSIX == %lu uptime\n&quot;</span>, sync_utc, sync_utt);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sync_duration_s = (when_utc - sync_utc);</div>
<div class="line">              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sync_duration_utt = sync_duration_s * utt_per_sec;</div>
<div class="line">              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> expected_utt = sync_utt + sync_duration_utt;</div>
<div class="line">              <span class="keywordtype">long</span> drift_utt = (long)state.pps_tt - (<span class="keywordtype">long</span>)expected_utt;</div>
<div class="line"></div>
<div class="line">              <span class="comment">/* Calculate the drift of uptime clock away from UTC</span></div>
<div class="line"><span class="comment">               * since the last synchronization. */</span></div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tUTT-to-UTC offset %ld after %u s; UTT &quot;</span>, drift_utt, sync_duration_s);</div>
<div class="line">              <span class="keywordflow">if</span> (0 &gt; drift_utt) {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; gained&quot;</span>);</div>
<div class="line">                drift_utt = -drift_utt;</div>
<div class="line">              } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; lost&quot;</span>);</div>
<div class="line">              }</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %s &quot;</span>, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(drift_utt, timestamp));</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; in %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(sync_duration_utt, timestamp));</div>
<div class="line">              <span class="comment">/* Reset synchronization epoch 90 seconds after first</span></div>
<div class="line"><span class="comment">               * sync to eliminate accumulated error when uptime clock</span></div>
<div class="line"><span class="comment">               * needed to warm up to stability and the GPS provided a</span></div>
<div class="line"><span class="comment">               * synchronization before that completed. */</span></div>
<div class="line">              <span class="keywordflow">if</span> ((1 == num_sync) &amp;&amp; (90 == sync_duration_s)) {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;** Reset sync\n&quot;</span>);</div>
<div class="line">                ++num_sync;</div>
<div class="line">                sync_utc = when_utc;</div>
<div class="line">                sync_utt = state.pps_tt;</div>
<div class="line">              }</div>
<div class="line">            }</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          <span class="comment">/* Some unrecognized binary message. */</span></div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s [%u]: Unhandled mid %u\n&quot;</span>, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(state.rx_utt, timestamp), state.msg_len, up-&gt;<a class="code" href="unionuSkyTraqMsg.html#a70c8feb84fbda0dbfdff198d19ff7040">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      msg_to_release = state.msg;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state.flags &amp; GPS_STATE_1PPS) {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t1PPS at %lu\n&quot;</span>, state.pps_tt);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state.flags &amp; GPS_STATE_TX_DONE) {</div>
<div class="line">      <span class="comment">/* Mark the transmission buffer as available */</span></div>
<div class="line">      tx_message.<a class="code" href="unionuSkyTraqMsgIn.html#a5ebcb2be2a304ef630102db0203af6b8">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a> = 0;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\tTX completed %d\n&quot;</span>, state.tx_rc);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* If we got an NMEA text message and the transmission buffer is</span></div>
<div class="line"><span class="comment">     * available, send a command to put the sensor into binary-output</span></div>
<div class="line"><span class="comment">     * mode. */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((state.flags &amp; GPS_STATE_SAW_NMEA) &amp;&amp; (0 == tx_message.<a class="code" href="unionuSkyTraqMsgIn.html#a5ebcb2be2a304ef630102db0203af6b8">generic</a>.<a class="code" href="structsSkyTraqMsg__GENERIC.html#ab0a486a5f9d4aac08a06d5ac42011f81">mid</a>)) {</div>
<div class="line">      <span class="keyword">struct </span><a class="code" href="structsSkyTraqMsgIn__CFG__FORMAT.html">sSkyTraqMsgIn_CFG_FORMAT</a> * mp = &amp;tx_message.cfg_format;</div>
<div class="line"></div>
<div class="line">      memset(mp, 0, <span class="keyword">sizeof</span>(*mp));</div>
<div class="line">      mp-&gt;<a class="code" href="structsSkyTraqMsgIn__CFG__FORMAT.html#ac31f01af265bfd679743a4894922ba2d">mid</a> = <a class="code" href="skytraq_8h.html#ab154e902f3b9f539b74cb95f21644341aaa7947127bc452ce9213a9f1b92d0a73">eSkyTraqMIDin_CFG_FORMAT</a>;</div>
<div class="line">      mp-&gt;<a class="code" href="structsSkyTraqMsgIn__CFG__FORMAT.html#af24bcf7a1dfa320f2d5af2630b74509f">type</a> = 2;</div>
<div class="line">      tx_length = <span class="keyword">sizeof</span>(*mp);</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Queued format=binary command\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_sensors_venus6pps_confic"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Use a crystal if one is installed.  Much more accurate timing</span></div>
<div class="line"><span class="comment"> * results. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Support console buffered input and output at a higher-than-normal</span></div>
<div class="line"><span class="comment"> * data rate. */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_TX_BUFFER_SIZE 100</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_RX_BUFFER_SIZE 16</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_BAUD_RATE 115200</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Add support to tell the user where to connect things */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_PERIPHERAL_HELP 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic timer, with delay support */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME_DELAY 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Need a CC register, preferably on the uptime timer, to use for 1PPS</span></div>
<div class="line"><span class="comment"> * capture.  Remember that CC0 is for RTOS switching, CC1 is the</span></div>
<div class="line"><span class="comment"> * default for configBSP430_UPTIME_DELAY, and CC2 is the default for</span></div>
<div class="line"><span class="comment"> * BSP430_TIMER_VALID_COUNTER_READ_CCIDX.  If your TA0 only has three</span></div>
<div class="line"><span class="comment"> * capture/compare registers, you may want to override</span></div>
<div class="line"><span class="comment"> * BSP430_UPTIME_TIMER_PERIPH_CPPID to select a more capable timer. */</span></div>
<div class="line"><span class="preprocessor">#if ((BSP430_PLATFORM_TRXEB - 0)                \</span></div>
<div class="line"><span class="preprocessor">     || (BSP430_PLATFORM_EXP430F5438 - 0))</span></div>
<div class="line"><span class="comment">/* TA0.3 == P1.4 CCI1A */</span></div>
<div class="line"><span class="preprocessor">#define APP_PPS_CCIDX 3</span></div>
<div class="line"><span class="preprocessor">#define APP_PPS_CCIS CCIS_0</span></div>
<div class="line"><span class="preprocessor">#define APP_PPS_PORT_PERIPH_HANDLE BSP430_PERIPH_PORT1</span></div>
<div class="line"><span class="preprocessor">#define APP_PPS_PORT_BIT BIT4</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_HAL_PORT1 1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Platform-specific UART for NMEA data */</span></div>
<div class="line"><span class="preprocessor">#if (BSP430_PLATFORM_TRXEB - 0)</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_HAL_USCI5_A0 1</span></div>
<div class="line"><span class="preprocessor">#define APP_NMEA_UART_PERIPH_HANDLE BSP430_PERIPH_USCI5_A0</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* Platform */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Site-specific baud rate for NMEA data */</span></div>
<div class="line"><span class="preprocessor">#ifndef APP_NMEA_BAUD_RATE</span></div>
<div class="line"><span class="preprocessor">#define APP_NMEA_BAUD_RATE 9600</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_NMEA_BAUD_RATE */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_sensors_venus6pps_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">PLATFORM ?= trxeb</div>
<div class="line">TEST_PLATFORMS=trxeb</div>
<div class="line">MODULES=$(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += periph/port</div>
<div class="line"></div>
<div class="line">VPATH += $(BSP430_ROOT)/src/sensors</div>
<div class="line">MODULES += sensors/skytraq</div>
<div class="line"></div>
<div class="line">CPPFLAGS += -Ifragpool/include</div>
<div class="line"></div>
<div class="line">SRC=main.c fragpool/src/fragpool.c</div>
<div class="line">include $(BSP430_ROOT)/examples/Makefile.common</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Mar 1 2014 16:30:48 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
